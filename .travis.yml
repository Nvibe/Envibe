language: java
# Use the OSS implementation of Oracle Java 1.8.0.
jdk: openjdk8
# Use Ubuntu Linux 18.04 Bionic to match Heroku's environment.
os: linux
dist: bionic
# Use PostgreSQL 12.2 to match Heroku's environment.
services:
  - postgresql
addons:
  postgresql: "12.2"
  apt:
    update: true
    packages:
      - postgresql-12.2
      - postgresql-client-12.2
# Specify environment variables for database integration.
env:
  global:
    - JDBC_DATABASE_URL=jdbc:postgres://postgres@127.0.0.1:5432/travis_ci_test
    - PGPORT=5432
# For some reason, we need to re-install Maven Wrapper and set the execute bit on the .sh file.
before_install:
  - mvn -N io.takari:maven:wrapper
  - chmod +x ./mvnw
# Initialize the database and perform all necessary migrations.
before_script:
  - psql -c 'CREATE DATABASE travis_ci_test;' -U postgres
  - mvn flyway:migrate
# Build project into JAR file for deployment onto Heroku.
before_deploy:
  - mvn clean package
deploy:
  provider: heroku
  # Use API method to avoid git collision issues.
  strategy: api
  app: envibe
  # Only deploy on master branch builds.
  on:
    branch: master
  # Use deploy API v2 as v1 is deprecated
  edge: true
  # Run database migrations on remote server before booting.
  run: mvn flyway:migrate